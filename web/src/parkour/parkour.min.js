"use strict";var Coin,Components,Entities,GameLayer,HudSystem,LayerTag,MenuLayer,Nodes,PhysicsSystem,PlayerSystem,Point,Reg,RenderSystem,Rock,RunnerStat,SimpleRecognizer,SpriteTag,SystemPriorities,TileMapSystem,groundHeight,res,runnerStartX,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};res={helloBG_png:"res/helloBG.png",start_n_png:"res/start_n.png",start_s_png:"res/start_s.png",PlayBG_png:"res/PlayBG.png",runner_png:"res/running.png",runner_plist:"res/running.plist",map_png:"res/map.png",map00_tmx:"res/map00.tmx",map01_tmx:"res/map01.tmx",background_png:"res/background.png",background_plist:"res/background.plist",restart_n_png:"res/restart_n.png",restart_s_png:"res/restart_s.png",background_mp3:"res/background.mp3",jump_mp3:"res/jump.mp3",pickup_coin_mp3:"res/pickup_coin.mp3"},groundHeight=57,runnerStartX=80,LayerTag={Background:0,Animation:1,Hud:2},SpriteTag={runner:0,coin:1,rock:2},RunnerStat={running:0,jumpUp:1,jumpDown:2},Reg=function(){function a(){}return a.score=0,a.lives=0,a.scored=new ash.signals.Signal2,a.killed=new ash.signals.Signal0,a}(),Components=function(){var a,b,c,d,e,f;return{Display:a=function(){function a(a){this.sprite=a}return a.prototype.sprite=null,a}(),Gravity:b=function(){function a(a,b){this.x=a,this.y=b}return a.prototype.x=0,a.prototype.y=0,a}(),Hud:c=function(){function a(a,b,c,d,e){this.coins=a,this.meter=b,this.lives=c,this.labelCoin=d,this.labelMeter=e}return a.prototype.coins=0,a.prototype.meter=0,a.prototype.lives=3,a.prototype.labelCoin=null,a.prototype.labelMeter=null,a}(),Player:d=function(){function a(a,b,c,d,e){this.sprite=a,this.body=b,this.runningAction=c,this.jumpUpAction=d,this.jumpDownAction=e}return a.prototype.sprite=null,a.prototype.body=null,a.prototype.runningAction=null,a.prototype.jumpUpAction=null,a.prototype.jumpDownAction=null,a}(),TileMap:e=function(){function a(a,b,c,d){this.mapWidth=a,this.spriteSheet=b,this.map00=c,this.map01=d}return a.prototype.mapWidth=0,a.prototype.spriteSheet=null,a.prototype.map00=null,a.prototype.map01=null,a}(),Transform:f=function(){function a(a,b,c){this.x=null!=a?a:0,this.y=null!=b?b:0,this.alpha=null!=c?c:1}return a.prototype.x=0,a.prototype.y=0,a.prototype.alpha=0,a}()}}(),Nodes=function(){var a,b,c,d,e;return{HudNode:a=function(){function a(){}return a.prototype.hud=Components.Hud,a}(),RenderNode:d=function(){function a(){}return a.prototype.display=Components.Display,a.prototype.transform=Components.Transform,a}(),PhysicsNode:b=function(){function a(){}return a.prototype.physics=Components.Gravity,a}(),PlayerNode:c=function(){function a(){}return a.prototype.player=Components.Player,a}(),TileMapNode:e=function(){function a(){}return a.prototype.tilemap=Components.TileMap,a}()}}(),Entities=function(){function a(a){this.game=a,this.ash=this.game.ash,this.world=this.game.world}var b,c,d,e,f,g,h;return b=Components.Display,d=Components.Gravity,e=Components.Hud,f=Components.Player,g=Components.TileMap,h=Components.Transform,c=ash.core.Entity,a.prototype.ash=null,a.prototype.game=null,a.prototype.world=null,a.prototype.destroyEntity=function(a){this.ash.removeEntity(a)},a.prototype.createImage=function(a,d,e,f){var g,i;return null==f&&(f=1),i=new cc.Sprite(e),this.game.addChild(i),g=new c,g.add(new b(i)),g.add(new h(a,d,f)),this.ash.addEntity(g),g},a.prototype.createTileMap=function(a,b,d,e){var f,h,i,j,k;return f=new cc.TMXTiledMap(a),this.game.addChild(f),i=f.getContentSize().width,h=new cc.TMXTiledMap(b),h.setPosition(cc.p(i,0)),this.game.addChild(h),cc.spriteFrameCache.addSpriteFrames(d),j=new cc.SpriteBatchNode(e),this.game.addChild(j),k=new c,k.add(new g(i,j,f,h)),this.ash.addEntity(k),k},a.prototype.createPhysics=function(a,b){var e,f;return this.world.gravity=cp.v(a,b),f=new cp.SegmentShape(this.world.staticBody,cp.v(0,groundHeight),cp.v(4294967295,groundHeight),0),this.world.addStaticShape(f),e=new c,e.add(new d(a,b)),this.ash.addEntity(e),e},a.prototype.createRunner=function(a,b){var d,e,g,h,i,j,k,l,m,n,o,p;return cc.spriteFrameCache.addSpriteFrames(a),p=new cc.SpriteBatchNode(b),this.game.addChild(p),d=function(){var a,b;for(b=[],i=a=0;8>a;i=++a)b.push(cc.spriteFrameCache.getSpriteFrame("runner"+i+".png"));return b}(),e=new cc.Animation(d,.1),m=new cc.RepeatForever(new cc.Animate(e)),m.retain(),d=function(){var a,b;for(b=[],i=a=0;4>a;i=++a)b.push(cc.spriteFrameCache.getSpriteFrame("runnerJumpUp"+i+".png"));return b}(),e=new cc.Animation(d,.2),k=new cc.RepeatForever(new cc.Animate(e)),k.retain(),d=function(){var a,b;for(b=[],i=a=0;2>a;i=++a)b.push(cc.spriteFrameCache.getSpriteFrame("runnerJumpDown"+i+".png"));return b}(),e=new cc.Animation(d,.3),j=new cc.RepeatForever(new cc.Animate(e)),j.retain(),o=new cc.PhysicsSprite("#runner0.png"),h=o.getContentSize(),g=new cp.Body(1,cp.momentForBox(1,h.width,h.height)),g.p=cc.p(runnerStartX,groundHeight+h.height/2),g.applyImpulse(cp.v(150,0),cp.v(0,0)),this.world.addBody(g),n=new cp.BoxShape(g,h.width-14,h.height),this.world.addShape(n),o.setBody(g),o.runAction(m),p.addChild(o),l=new c,l.add(new f(o,g,m,k,j)),this.ash.addEntity(l),l},a.prototype.createHud=function(a,b,d){var f,g,h,i;return i=cc.director.getWinSize(),g=new cc.LabelTTF("Coins:0","Helvetica",20),g.setColor(cc.color(0,0,0)),g.setPosition(cc.p(70,i.height-20)),this.game.addChild(g),h=new cc.LabelTTF("0M","Helvetica",20),h.setPosition(cc.p(i.width-70,i.height-20)),this.game.addChild(h),f=new c,f.add(new e(a,b,d,g,h)),this.ash.addEntity(f),f},a}(),SystemPriorities=function(){function a(){}return a.preUpdate=1,a.update=2,a.move=3,a.resolveCollisions=4,a.stateMachines=5,a.render=6,a.animate=7,a}(),HudSystem=function(a){function b(a){this.game=a,this.updateNode=__bind(this.updateNode,this),b.__super__.constructor.call(this,this.game.reg.nodes.HudNode,this.updateNode),this.player=this.game.player}return __extends(b,a),b.prototype.shapesToRemove=null,b.prototype.updateNode=function(a,b){var c,d,e,f;e=cc.director.getWinSize(),f=this.player.get(Components.Player).sprite.getPositionX()-runnerStartX,c=a.hud.labelCoin,c.setPosition(cc.p(f+70,e.height-20)),c.setString("Coins:"+a.hud.coins),d=a.hud.labelMeter,d.setPosition(cc.p(f+e.width-70,e.height-20)),d.setString(parseInt(a.hud.meter/10)+"M")},b}(ash.tools.ListIteratingSystem),PhysicsSystem=function(a){function b(a){this.game=a,this.updateNode=__bind(this.updateNode,this),b.__super__.constructor.call(this,this.game.reg.nodes.PhysicsNode,this.updateNode),this.world=this.game.world,this.player=this.game.player,this.hud=this.game.hud,this.world.addCollisionHandler(SpriteTag.runner,SpriteTag.coin,this.collisionCoinBegin.bind(this),null,null,null),this.world.addCollisionHandler(SpriteTag.runner,SpriteTag.rock,this.collisionRockBegin.bind(this),null,null,null)}return __extends(b,a),b.prototype.player=null,b.prototype.hud=null,b.prototype.updateNode=function(a,b){var c;this.world.step(b),c=this.player.get(Components.Player).sprite.getPositionX()-runnerStartX,this.game.setPosition(cc.p(-c,0))},b.prototype.collisionCoinBegin=function(a,b){Reg.scored.dispatch(1,a.getShapes()),this.hud.get(Components.Hud).coins++,cc.audioEngine.playEffect(res.pickup_coin_mp3)},b.prototype.collisionRockBegin=function(a,b){this.hud.get(Components.Hud).lives--<0&&Reg.killed.dispatch()},b}(ash.tools.ListIteratingSystem),PlayerSystem=function(a){function b(a){this.game=a,this.updateNode=__bind(this.updateNode,this),b.__super__.constructor.call(this,this.game.reg.nodes.PlayerNode,this.updateNode),this.hud=this.game.hud}return __extends(b,a),b.prototype.stat=RunnerStat.running,b.prototype.hud=null,b.prototype.updateNode=function(a,b){var c,d;d=a.player.body.getVel(),c=a.player.sprite,this.hud.get(Components.Hud).meter=c.getPositionX()-runnerStartX,this.stat===RunnerStat.jumpUp?d.y<.1&&(this.stat=RunnerStat.jumpDown,c.stopAllActions(),c.runAction(a.player.jumpDownAction)):this.stat===RunnerStat.jumpDown&&0===d.y&&(this.stat=RunnerStat.running,c.stopAllActions(),c.runAction(a.player.runningAction))},b}(ash.tools.ListIteratingSystem),RenderSystem=function(a){function b(a){this.level=a,this.updateNode=__bind(this.updateNode,this),b.__super__.constructor.call(this,this.level.reg.nodes.RenderNode,this.updateNode)}return __extends(b,a),b.prototype.updateNode=function(a,b){var c,d,e;c=cc.director.getWinSize(),d=a.transform.x+c.width/2,e=a.transform.y+c.height/2,a.display.sprite.setPosition(cc.p(d,e))},b}(ash.tools.ListIteratingSystem),TileMapSystem=function(a){function b(a){this.game=a,this.updateNode=__bind(this.updateNode,this),b.__super__.constructor.call(this,this.game.reg.nodes.TileMapNode,this.updateNode),this.world=this.game.world,this.player=this.game.player,this.objects=[],this.deadPool=[],Reg.scored.add(function(a){return function(b,c){return console.log("Score ",b),a.deadPool.push(c[1])}}(this))}return __extends(b,a),b.prototype.first=!0,b.prototype.level=null,b.prototype.world=null,b.prototype.objects=null,b.prototype.player=null,b.prototype.mapIndex=0,b.prototype.deadPool=null,b.prototype.updateNode=function(a,b){var c,d,e,f,g,h,i;for(c=a.tilemap.map00,d=a.tilemap.map01,e=a.tilemap.mapWidth,h=a.tilemap.spriteSheet,this.first&&(this.first=!1,this.loadObjects(c,0,e,h),this.loadObjects(d,1,e,h)),i=this.player.get(Components.Player).sprite.getPositionX()-runnerStartX,f=parseInt(i/e),this.mapIndex!==f&&(0===f%2?(d.setPositionX(e*(f+1)),this.loadObjects(d,f+1,e,h)):(c.setPositionX(e*(f+1)),this.loadObjects(c,f+1,e,h)),this.removeObjects(f-1),this.mapIndex=f);null!=(g=this.deadPool.pop());)this.removeObjectByShape(g)},b.prototype.loadObjects=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o;for(g=a.getObjectGroup("coin"),f=g.getObjects(),l=0,n=f.length;n>l;l++)h=f[l],e=new Coin(d,this.world,cc.p(h.x+c*b,h.y)),e.mapIndex=b,this.objects.push(e);for(k=a.getObjectGroup("rock"),j=k.getObjects(),m=0,o=j.length;o>m;m++)h=j[m],i=new Rock(d,this.world,cc.p(h.x+c*b,h.y)),i.mapIndex=b,this.objects.push(i)},b.prototype.removeObjects=function(a){for(;function(a,b){var c,d,e;for(c=d=0,e=a.length;e>=0?e>d:d>e;c=e>=0?++d:--d)if(a[c].mapIndex===b)return a[c].removeFromParent(),a.splice(c,1),!0;return!1}(this.objects,a);)return},b.prototype.removeObjectByShape=function(a){var b,c,d;for(b=c=0,d=this.objects.length;d>=0?d>c:c>d;b=d>=0?++c:--c)if(this.objects[b].getShape()===a){this.objects[b].removeFromParent(),this.objects.splice(b,1);break}},b}(ash.tools.ListIteratingSystem),MenuLayer=cc.Layer.extend({ctor:function(){var a,b,c,d,e;this._super(),e=cc.director.getWinSize(),a=cc.p(e.width/2,e.height/2),d=new cc.Sprite(res.helloBG_png),d.setPosition(a),this.addChild(d),cc.MenuItemFont.setFontSize(60),c=new cc.MenuItemSprite(new cc.Sprite(res.start_n_png),new cc.Sprite(res.start_s_png),function(){return cc.director.runScene(GameLayer.scene())},this),b=new cc.Menu(c),b.setPosition(a),this.addChild(b)}}),MenuLayer.scene=function(){var a;return a=new cc.Scene,a.addChild(new MenuLayer),a},GameLayer=cc.Layer.extend({ash:null,reg:null,entities:null,world:null,player:null,hud:null,ctor:function(){this._super(),this.ash=new ash.core.Engine,this.reg=new ash.ext.Helper(Components,Nodes),this.world=new cp.Space,this.entities=new Entities(this),this.entities.createPhysics(0,-350),this.entities.createImage(0,0,res.PlayBG_png),this.entities.createTileMap(res.map00_tmx,res.map01_tmx,res.background_plist,res.background_png),this.hud=this.entities.createHud(0,3),this.player=this.entities.createRunner(res.runner_plist,res.runner_png),this.ash.addSystem(new RenderSystem(this),SystemPriorities.render),this.ash.addSystem(new TileMapSystem(this),SystemPriorities.render),this.ash.addSystem(new HudSystem(this),SystemPriorities.render),this.ash.addSystem(new PlayerSystem(this),SystemPriorities.move),this.ash.addSystem(new PhysicsSystem(this),SystemPriorities.resolveCollisions),this.scheduleUpdate()},update:function(a){this.ash.update(a)}}),GameLayer.scene=function(){var a;return a=new cc.Scene,a.addChild(new GameLayer),a},Coin=cc.Class.extend({world:null,sprite:null,shape:null,mapIndex:0,getShape:function(){return this.shape},ctor:function(a,b,c){var d,e,f,g,h,i;this.world=b,e=function(){var a,b;for(b=[],h=a=0;8>a;h=++a)b.push(cc.spriteFrameCache.getSpriteFrame("coin"+h+".png"));return b}(),f=new cc.Animation(e,.2),d=new cc.RepeatForever(new cc.Animate(f)),this.sprite=new cc.PhysicsSprite("#coin0.png"),i=.95*this.sprite.getContentSize().width/2,g=new cp.StaticBody,g.setPos(c),this.sprite.setBody(g),this.shape=new cp.CircleShape(g,i,cp.vzero),this.shape.setCollisionType(SpriteTag.coin),this.shape.setSensor(!0),this.world.addStaticShape(this.shape),this.sprite.runAction(d),a.addChild(this.sprite,1)},removeFromParent:function(){this.world.removeStaticShape(this.shape),this.shape=null,this.sprite.removeFromParent(),this.sprite=null}}),Rock=cc.Class.extend({world:null,sprite:null,shape:null,map:0,getShape:function(){return this.shape},ctor:function(a,b,c){var d;this.world=b,this.sprite=new cc.PhysicsSprite("#rock.png"),d=new cp.StaticBody,d.setPos(cc.p(c.x,this.sprite.getContentSize().height/2+groundHeight)),this.sprite.setBody(d),this.shape=new cp.BoxShape(d,this.sprite.getContentSize().width,this.sprite.getContentSize().height),this.shape.setCollisionType(SpriteTag.rock),this.world.addStaticShape(this.shape),a.addChild(this.sprite)},removeFromParent:function(){this.world.removeStaticShape(this.shape),this.shape=null,this.sprite.removeFromParent(),this.sprite=null}}),Point=function(){function a(a,b){this.X=a,this.Y=b}return a}(),SimpleRecognizer=function(){function a(){this.points=[],this.result=""}return a.prototype.points=null,a.prototype.result=null,a.prototype.getPoints=function(){return this.points},a.prototype.beginPoint=function(a,b){this.points=[],this.result="",this.points.push(new Point(a,b))},a.prototype.movePoint=function(a,b){var c,d,e,f;return this.points.push(new Point(a,b)),"not supported"!==this.result?(f="",e=this.points.length,c=this.points[e-1].X-this.points[e-2].X,d=this.points[e-1].Y-this.points[e-2].Y,f=Math.abs(c)>Math.abs(d)?c>0?"right":"left":d>0?"up":"down",""===this.result?void(this.result=f):void(this.result!==f&&(this.result="not support"))):void 0},a.prototype.endPoint=function(){return this.points.length<3?"error":this.result},a}();